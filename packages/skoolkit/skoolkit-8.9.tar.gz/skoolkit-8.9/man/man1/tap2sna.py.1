.\" Man page generated from reStructuredText.
.
.TH "TAP2SNA.PY" "1" "Feb 19, 2023" "8.9" "SkoolKit"
.SH NAME
tap2sna.py \- convert a TAP or TZX file into a snapshot file
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH SYNOPSIS
.nf
\fBtap2sna.py\fP [options] INPUT snapshot.z80
\fBtap2sna.py\fP @FILE [args]
.fi
.sp
.SH DESCRIPTION
.sp
\fBtap2sna.py\fP converts a TAP or TZX file (which may be inside a zip archive)
into a Z80 snapshot. INPUT may be the full URL to a remote zip archive or
TAP/TZX file, or the path to a local file. Arguments may be read from FILE
instead of (or as well as) being given on the command line.
.SH OPTIONS
.INDENT 0.0
.TP
.B \-c, \-\-sim\-load\-config name=value
Set the value of a \fB\-\-sim\-load\fP configuration parameter. Do \fB\-c help\fP for
more information, and see the section on \fBSIMULATED LOAD\fP below. This
option may be used multiple times.
.TP
.B \-d, \-\-output\-dir \fIDIR\fP
Write the snapshot file in this directory.
.UNINDENT
.INDENT 0.0
.TP
.B \-f\fP,\fB  \-\-force
Overwrite an existing snapshot.
.UNINDENT
.INDENT 0.0
.TP
.B \-p, \-\-stack \fISTACK\fP
Set the stack pointer. This option is equivalent to \fB\-\-reg sp=STACK\fP\&.
\fISTACK\fP must be a decimal number, or a hexadecimal number prefixed by \(aq0x\(aq.
.UNINDENT
.INDENT 0.0
.TP
.BI \-\-ram \ OPERATION
Perform a load operation or otherwise modify the memory snapshot being built.
Do \fB\-\-ram help\fP for more information, or see the sections on the \fBCALL\fP,
\fBLOAD\fP, \fBMOVE\fP, \fBPOKE\fP and \fBSYSVARS\fP operations below. This option
may be used multiple times.
.UNINDENT
.INDENT 0.0
.TP
.B \-\-reg name=value
Set the value of a register. Do \fB\-\-reg help\fP for more information, or see
the section on \fBREGISTERS\fP below. This option may be used multiple times.
.TP
.B \-s, \-\-start \fISTART\fP
Set the start address to JP to. This option is equivalent to
\fB\-\-reg pc=START\fP\&. \fISTART\fP must be a decimal number, or a hexadecimal number
prefixed by \(aq0x\(aq.
.UNINDENT
.INDENT 0.0
.TP
.B \-\-sim\-load
Simulate a 48K ZX Spectrum running LOAD "". See the section on \fBSIMULATED
LOAD\fP below.
.UNINDENT
.INDENT 0.0
.TP
.B \-\-state name=value
Set a hardware state attribute. Do \fB\-\-state help\fP for more information, or
see the section on \fBHARDWARE STATE\fP below. This option may be used multiple
times.
.UNINDENT
.INDENT 0.0
.TP
.BI \-\-tape\-name \ NAME
Specify the name of a TAP/TZX file in a zip archive. By default, the first
TAP/TZX file found in the zip archive is selected.
.TP
.BI \-\-tape\-start \ BLOCK
Start the tape at this block number. In a TAP/TZX file, the first block is
number 1, the second is 2, etc.
.TP
.BI \-\-tape\-stop \ BLOCK
Stop the tape at this block number. In a TAP/TZX file, the first block is
number 1, the second is 2, etc.
.TP
.BI \-\-tape\-sum \ MD5SUM
Specify the MD5 checksum of the TAP/TZX file. \fBtap2sna.py\fP will abort if
there is a checksum mismatch.
.UNINDENT
.INDENT 0.0
.TP
.B \-u, \-\-user\-agent \fIAGENT\fP
Set the User\-Agent header used in an HTTP(S) request.
.UNINDENT
.INDENT 0.0
.TP
.B \-V\fP,\fB  \-\-version
Show the SkoolKit version number and exit.
.UNINDENT
.SH TZX SUPPORT
.sp
\fBtap2sna.py\fP can read data from TZX block types 0x10 (standard speed data),
0x11 (turbo speed data) and 0x14 (pure data), but not block types 0x15 (direct
recording), 0x18 (CSW recording) or 0x19 (generalized data block).
.SH SIMULATED LOAD
.sp
The \fB\-\-sim\-load\fP option simulates a freshly booted 48K ZX Spectrum running
LOAD "" (or LOAD ""CODE, if the first block on the tape is a \(aqBytes\(aq header).
Whenever the Spectrum ROM\(aqs load routine at $0556 is called, a shortcut is
taken by "fast loading" the next block on the tape. All other code (including
any custom loader) is fully simulated. Simulation continues until the program
counter hits the start address given by the \fB\-\-start\fP option, or 10 minutes
of simulated Z80 CPU time has elapsed, or the end of the tape is reached and
one of the following conditions is satisfied:
.INDENT 0.0
.IP \(bu 2
a custom loader was detected
.IP \(bu 2
the program counter hits an address outside the ROM
.IP \(bu 2
more than one second of simulated Z80 CPU time has elapsed since the end of
the tape was reached
.UNINDENT
.sp
A simulated LOAD can also be aborted by pressing Ctrl\-C. When a simulated LOAD
has completed or been aborted, the values of the registers (including the
program counter) in the simulator are used to populate the Z80 snapshot.
.sp
A simulated LOAD can be configured via parameters that are set by the
by the \fB\-\-sim\-load\-config\fP (or \fB\-c\fP) option. The recognised configuration
parameters are:
.INDENT 0.0
.IP \(bu 2
\fBaccelerator\fP \- the tape\-sampling loop accelerator to use (default:
automatically selected \- see below); use this to specify a particular
accelerator (which may produce a faster simulated LOAD), or to disable
acceleration entirely (\fBaccelerator=none\fP)
.IP \(bu 2
\fBfast\-load\fP \- enable fast loading (\fB1\fP, the default), or disable it
(\fB0\fP); fast loading significantly reduces the load time for many tapes, but
can also cause some loaders to fail
.IP \(bu 2
\fBfirst\-edge\fP \- the time (in T\-states) from the start of the tape at which
to place the leading edge of the first pulse (default: \fB\-2168\fP); the
default value places the trailing edge of the first pulse at time 0, but some
loaders (e.g. polarity\-sensitive loaders) require \fBfirst\-edge=0\fP
.IP \(bu 2
\fBpause\fP \- pause the tape between blocks and resume playback when port 254
is read (\fB1\fP, the default), or run the tape continuously (\fB0\fP); pausing
can help with tapes that require (but do not actually contain) long pauses
between blocks, but can cause some loaders to fail
.IP \(bu 2
\fBtimeout\fP \- the number of seconds of Z80 CPU time after which to abort the
simulated LOAD if it\(aqs still in progress (default: 900)
.IP \(bu 2
\fBtrace\fP \- the file to which to log all instructions executed during the
simulated LOAD (default: none)
.UNINDENT
.sp
The names of the available tape\-sampling loop accelerators are:
.nf

.in +2
\fBalkatraz\fP \- Alkatraz
\fBalkatraz2\fP \- Alkatraz 2
\fBbleepload\fP \- Firebird BleepLoad
\fBcyberlode\fP \- Cyberlode 1.1
\fBdigital\-integration\fP \- Digital Integration
\fBdinaload\fP \- Dinaload
\fBedge\fP \- Edge
\fBelite\-uni\-loader\fP \- Elite Uni\-Loader
\fBexcelerator\fP \- The Excelerator Loader
\fBflash\-loader\fP \- Flash Loader
\fBftl\fP \- FTL
\fBgargoyle\fP \- Gargoyle
\fBgremlin\fP \- various games published by Gremlin Graphics
\fBhewson\-slowload\fP \- Hewson Slowload
\fBinjectaload\fP \- Injectaload
\fBmicrosphere\fP \- Back to Skool, Skool Daze, Sky Ranger
\fBnone\fP \- no accelerator
\fBpaul\-owens\fP \- Paul Owens Protection System
\fBpoliload\fP \- Poliload
\fBpower\-load\fP \- Power\-Load
\fBrom\fP \- any loader whose sampling loop is the same as the ROM\(aqs
\fBsearch\-loader\fP \- Search Loader
\fBsoftlock\fP \- SoftLock
\fBspeedlock\fP \- Speedlock (all versions)
\fBzydroload\fP \- Zydroload
.in -2
.fi
.sp
.SH CALL OPERATIONS
.sp
The \fB\-\-ram\fP option can be used to call a Python function to perform arbitrary
modification of the memory snapshot.
.nf

.in +2
\fB\-\-ram call=[/path/to/moduledir:]module.function\fP
.in -2
.fi
.sp
.sp
The function is called with the memory snapshot (a list of 65536 byte values)
as the sole positional argument. The function must modify the snapshot in
place. The path to the module\(aqs location may be omitted if the module is
already in the module search path.
.sp
For example:
.nf

.in +2
\fB\-\-ram call=:ram.modify\fP # Call modify(snapshot) in ./ram.py
.in -2
.fi
.sp
.SH LOAD OPERATIONS
.sp
By default, \fBtap2sna.py\fP loads bytes from every data block on the tape, using
the start address given in the corresponding header. For tapes that contain
headerless data blocks, headers with incorrect start addresses, or irrelevant
blocks, the \fB\-\-ram\fP option can be used to load bytes from specific blocks at
the appropriate addresses. The syntax is:
.nf

.in +2
\fB\-\-ram load=[+]block[+],start[,length,step,offset,inc]\fP
.in -2
.fi
.sp
.sp
where the parameters have the following meanings:
.INDENT 0.0
.TP
.B \fBblock\fP
The tape block number; the first block is 1, the next is 2, etc. Attach a \(aq+\(aq
prefix to load the first byte of the block (which is usually the flag byte),
and a \(aq+\(aq suffix to load the last byte (which is usually the parity byte).
.TP
.B \fBstart\fP
The destination address at which to start loading.
.TP
.B \fBlength\fP
The number of bytes to load (optional; defaults to the number of bytes
remaining in the block).
.TP
.B \fBstep\fP
This number is added to the destination address after each byte is loaded
(optional; default=1).
.TP
.B \fBoffset\fP
This number is added to the destination address before a byte is loaded, and
subtracted after the byte is loaded (optional; default=0). It is analogous to
the offset \fBd\fP in the \fBLD (IX+d),L\fP operation that is commonly used in
load routines to copy the byte just loaded from tape (\fBL\fP) into memory.
.TP
.B \fBinc\fP
After \fBstep\fP is added to the destination address, this number is added too
if the result overflowed past 65535 (optional; default=0).
.UNINDENT
.sp
A single tape block can be loaded in two or more stages; for example:
.nf

.in +2
\fB\-\-ram load=2,32768,2048\fP # Load the first 2K at 32768
\fB\-\-ram load=2,0xC000\fP     # Load the remainder at 49152
.in -2
.fi
.sp
.SH MOVE OPERATIONS
.sp
The \fB\-\-ram\fP option can be used to move a block of bytes from one location to
another before saving the snapshot.
.nf

.in +2
\fB\-\-ram move=src,N,dest\fP
.in -2
.fi
.sp
.sp
This moves a block of \fBN\fP bytes from \fBsrc\fP to \fBdest\fP\&. For example:
.nf

.in +2
\fB\-\-ram move=32512,256,32768\fP     # Move 32512\-32767 to 32768\-33023
\fB\-\-ram move=0x9c00,0x100,0x9d00\fP # Move 39936\-40191 to 40192\-40447
.in -2
.fi
.sp
.SH POKE OPERATIONS
.sp
The \fB\-\-ram\fP option can be used to POKE values into the snapshot before saving
it.
.nf

.in +2
\fB\-\-ram poke=A[\-B[\-C]],[^+]V\fP
.in -2
.fi
.sp
.sp
This does \fBPOKE N,V\fP for \fBN\fP in \fB{A, A+C, A+2C..., B}\fP, where:
.sp
\fBA\fP is the first address to POKE
.sp
\fBB\fP is the last address to POKE (optional; default is \fBA\fP)
.sp
\fBC\fP is the step (optional; default=1)
.sp
\fBV\fP is the value to POKE; prefix the value with \(aq^\(aq to perform an XOR
operation, or \(aq+\(aq to perform an ADD operation
.sp
For example:
.nf

.in +2
\fB\-\-ram poke=0x6000,0x10\fP     # POKE 24576,16
\fB\-\-ram poke=30000\-30002,^85\fP # Perform \(aqXOR 85\(aq on addresses 30000\-30002
\fB\-\-ram poke=40000\-40004\-2,1\fP # POKE 40000,1: POKE 40002,1: POKE 40004,1
.in -2
.fi
.sp
.SH SYSVARS OPERATION
.sp
The \fB\-\-ram\fP option can be used to initialise the system variables at
23552\-23754 (5C00\-5CCA) with values suitable for a 48K ZX Spectrum.
.nf

.in +2
\fB\-\-ram sysvars\fP
.in -2
.fi
.sp
.SH REGISTERS
.sp
The \fB\-\-reg\fP option sets the value of a register in the snapshot.
.nf

.in +2
\fB\-\-reg name=value\fP
.in -2
.fi
.sp
.sp
For example:
.nf

.in +2
\fB\-\-reg hl=32768\fP
\fB\-\-reg b=0x1f\fP
.in -2
.fi
.sp
.sp
To set the value of an alternate (shadow) register, use the \(aq^\(aq prefix:
.nf

.in +2
\fB\-\-reg ^hl=10072\fP
.in -2
.fi
.sp
.sp
Recognised register names are:
.nf

.in +2
\fB^a\fP, \fB^b\fP, \fB^bc\fP, \fB^c\fP, \fB^d\fP, \fB^de\fP, \fB^e\fP, \fB^f\fP, \fB^h\fP, \fB^hl\fP, \fB^l\fP,
\fBa\fP, \fBb\fP, \fBbc\fP, \fBc\fP, \fBd\fP, \fBde\fP, \fBe\fP, \fBf\fP, \fBh\fP, \fBhl\fP, \fBl\fP,
\fBi\fP, \fBix\fP, \fBiy\fP, \fBpc\fP, \fBr\fP, \fBsp\fP
.in -2
.fi
.sp
.sp
The default value for each register is 0, with the following exceptions:
.nf

.in +2
\fBi=63\fP
\fBiy=23610\fP
.in -2
.fi
.sp
.SH HARDWARE STATE
.sp
The \fB\-\-state\fP option sets a hardware state attribute.
.nf

.in +2
\fB\-\-state name=value\fP
.in -2
.fi
.sp
.sp
Recognised attribute names and their default values are:
.nf

.in +2
\fBborder\fP  \- border colour (default=0)
\fBiff\fP     \- interrupt flip\-flop: 0=disabled, 1=enabled (default=1)
\fBim\fP      \- interrupt mode (default=1)
\fBtstates\fP \- T\-states elapsed since start of frame (default=0)
.in -2
.fi
.sp
.SH READING ARGUMENTS FROM A FILE
.sp
For complex snapshots that require many \fB\-\-ram\fP, \fB\-\-reg\fP or \fB\-\-state\fP
options to build, it may be more convenient to store the arguments to
\fBtap2sna.py\fP in a file. For example, if the file \fBgame.t2s\fP has the
following contents:
.nf

.in +2
;
; tap2sna.py file for GAME
;
http://example.com/pub/games/GAME.zip
game.z80
\-\-ram load=4,32768         # Load the fourth block at 32768
\-\-ram move=40960,512,43520 # Move 40960\-41471 to 43520\-44031
\-\-ram call=:ram.modify     # Call modify(snapshot) in ./ram.py
\-\-ram sysvars              # Initialise the system variables
\-\-state iff=0              # Disable interrupts
\-\-stack 32768              # Stack at 32768
\-\-start 34816              # Start at 34816
.in -2
.fi
.sp
.sp
then:
.nf

.in +2
\fBtap2sna.py @game.t2s\fP
.in -2
.fi
.sp
.sp
will create \fBgame.z80\fP as if the arguments specified in \fBgame.t2s\fP had been
given on the command line.
.SH EXAMPLES
.INDENT 0.0
.IP 1. 3
Extract the TAP or TZX file from a remote zip archive and convert it into a
Z80 snapshot:
.nf

.in +2
\fBtap2sna.py ftp://example.com/game.zip game.z80\fP
.in -2
.fi
.sp
.IP 2. 3
Extract the TAP or TZX file from a zip archive, and convert it into a Z80
snapshot with the program counter set to 32768:
.nf

.in +2
\fBtap2sna.py \-\-reg pc=32768 game.zip game.z80\fP
.in -2
.fi
.sp
.IP 3. 3
Convert a TZX file into a Z80 snapshot by loading the third block on the
tape at 25000:
.nf

.in +2
\fBtap2sna.py \-\-ram load=3,25000 game.tzx game.z80\fP
.in -2
.fi
.sp
.IP 4. 3
Convert a TZX file into a Z80 snapshot using options read from the file
\fBgame.t2s\fP:
.nf

.in +2
\fBtap2sna.py @game.t2s game.tzx game.z80\fP
.in -2
.fi
.sp
.UNINDENT
.SH AUTHOR
Richard Dymond
.SH COPYRIGHT
2023, Richard Dymond
.\" Generated by docutils manpage writer.
.
